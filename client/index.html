<html>
<head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
</head>
<body>    
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.js"></script>

	<!-- Header panel -->
	<div class="indigo z-depth-4">
		<div class="row">
			<div class="col s10 offset-s1">
				<h1 class="header white-text center-on-small-only">JS Executor Service</h1>
				<h4 class="light white-text text-lighten-4 center-on-small-only">Client</h4>
			</div>
		</div>
	</div>

	<!-- Card with form -->
	<div id="card" class="row" style="margin-top:100px">
		<div class="col s10 m6 offset-s1 offset-m3">
			<div class="card blue-grey darken-1 z-depth-4">
				<div class="card-content white-text">
					<span class="card-title">Choose file</span>
					<p>This file has to contain one Javascript function. After submitting it will be calculated on the server and you will be informed about results.</p>
				</div>
				<div class="card-action">
					<div class="row">
						<div class="col s8 offset-s2">
							<form id="uploadForm"
							enctype="multipart/form-data"
							method="post"
							style="margin:auto">
								<div class="file-field input-field">
									<div class="btn-large orange darken-2 waves-effect waves-light">
										<span>Choose file</span>
										<input type="file" name="function_file">
									</div>
									<div class="file-path-wrapper">
										<input id="file_name" class="file-path validate" type="text">
									</div>
								</div>
							</form>

							<div id="progress" class="row">
								<div class="col s2 offset-s5">
									<div class="preloader-wrapper active" style="margin:auto">
										<div class="spinner-layer spinner-blue-only">
											<div class="circle-clipper left">
												<div class="circle"></div>
											</div>
											<div class="gap-patch">
												<div class="circle"></div>
											</div>
											<div class="circle-clipper right">
												<div class="circle"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="resultRow" class="row" style="margin-top:100px">
		<div class="col s10 m6 offset-s1 offset-m3">
			<div class="card blue-grey darken-1 z-depth-4">
				<div class="card-content white-text">
					<div class="row">
						<h4 style="text-align:center" class="light white-text text-lighten-4 center-on-small-only">Result</h4>
					</div>
					<div class="row">
						<h6 id="result" style="text-align:center" class="light white-text text-lighten-4 center-on-small-only"></h6>
					</div>
					<div class="row">
						<div class="col s8 offset-s2">
							<div class="btn-large orange darken-2 waves-effect waves-light" style="width:100%" onclick="reset()">
								<span>One more?</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Argument modal -->
	<div id="argument_modal" class="modal">
		<div id="modal-content" class="modal-content">
			<h4 id="modal-title"></h4>
			<div id="arguments"></div>
		</div>
		<div class="modal-footer">
			<div class="modal-action modal-close waves-effect waves-green btn-flat" onclick="gatherUserArgs()">Proceed</div>
		</div>
	</div>

<script>
var functionExecuting = false;  
// Init modal
$(document).ready(function(){
    $('.modal').modal({
    	complete: function() {
    		if (!functionExecuting)
    			reset();
    		$("#arguments").empty();
    	}});
});

$("#progress").hide();
$("#resultRow").hide();

$('#uploadForm').ajaxForm({
	url : '',
	dataType : 'json',
	success : function (response) {
		args = response.result;
		console.log(args);
		if (args.length == 0)
			execute([]);
		else
			askForArguments(args);
	},
	error : function (xhr, ajaxOptions, thrownError) {
		console.log(thrownError);
	}
});


$(document).on('change', '#file_name', function() {
	console.log("Submitting");
	$("#progress").show();
	$("#uploadForm").submit();
});

function reset() {
	$("#resultRow").hide();
	$("#progress").hide();
	$('#uploadForm')[0].reset();
	$("#card").show();
}

function execute(args) {
	$.ajax({
	    type: "POST",
	    url: "/execute",
	    contentType: "application/json; charset=utf-8",
	    dataType: "json",
	    data: JSON.stringify({ args: args }),
		success : function (response) {
			functionExecuting = false;
			$("#card").hide();
			$("#resultRow").show();
			$("#result").text("The server says: " + response.result);
		},
		error : function (xhr, ajaxOptions, thrownError) {
			functionExecuting = false;
			$("#card").hide();
			$("#resultRow").show();
			$("#result").text(thrownError);
		}
	});
}

function askForArguments(args) {
	$("#modal-title").text("Function you provided requires arguments. Please fill them out.");
	var innerHTML = "";
    for (i = 0; i < args.length; i++) {
    	console.log(i);
    	if ((i % 3) == 0) {
    		if (i != 0) {
    			console.log("close: " + i);
    			innerHTML += "</row>";	
    		}
    		console.log("open: " + i);
    		innerHTML += "<row>";
    	}
    	innerHTML += "<div class=\"input-field col s3 offset-s1\" style=\"display:inline-block; margin:3%\">" +
    		"<input id=\"arg" + i + "\" type=\"text\" class=\"validate\" style=\"margin-bottom:0\">" +
    		"<label for=arg" + i + "\">" + args[i] + "</label>" +
    		"</div>";
    }
    innerHTML += "</row>";
    $("#arguments").append(innerHTML);

    $("#argument_modal").modal('open');
}

function gatherUserArgs() {
	var values = [];

	$('#arguments > row > .input-field > input').each(
		function(i, item) { 
			values.push($("#" + item.id).val());
		}
	);

	functionExecuting = true;
    $("#argument_modal").modal('close');
    $("#arguments").empty();
	execute(values);
}
</script>
</body>
</html>